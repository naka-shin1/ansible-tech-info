
[↑トップページに戻る](../README.md)
<br>
# トラブルシューティング (SmartCS x Ansible)

本ページでは、Ansible のエラーメッセージが出力されず、SmartCS x Ansible の連携で期待する実行結果とならない場合の対処を説明しています。  
実行結果、想定される原因および対処方法について記載しています。  
Playbook 実行時にAnsible のエラーメッセージが出力される場合の対処方法は、[トラブルシューティング（Ansible）](./troubleshooting.md)を参照してください。  

`注意事項`  
記載されている対処方法により期待するオペレーションを必ず実現できるとは限りません。  
実現のための参考情報としてご活用いただけますと幸いです。  

<br>

## 目次
- [1. sendchar で指定した文字列が想定通りに実行されません。](./smartcsmoduletips.md#1-sendchar-で指定した文字列が想定通りに実行されません)
- [2. sendchar で指定した文字列の実行結果がstdout_lines_customのresponseに正しく格納されず、途中で切れてしまいます。](./smartcsmoduletips.md#2-sendchar-で指定した文字列の実行結果がstdout_lines_customのresponseに正しく格納されず途中で切れてしまいます)

<br>
<br>

## 1. sendchar で指定した文字列が想定通りに実行されません。
#### 想定原因
`recvchar` に指定する文字列に不足/誤りがあり文字列の送受信が途中で停止している、あるいはターゲット機器のコンソールが既にログイン後の状態となっているなどPlaybook 開始時点で想定された状態となっていない可能性があります。  

#### 対処方法
1. `recvchar` に指定する文字列に不足/誤りがある場合  
   - `sendchar` で指定したコマンドを実行した際に、ターゲット機器のコンソールから出力される文字列を再度ご確認ください。
また、`recvchar` で指定する文字列に不要な半角スペースなどが含まれている場合、受信した文字列が`recvchar` に含まれていないと判断されます。  
受信する文字列が`recvchar` で正しく指定されているかどうか、併せてご確認ください。  
   - なお、`smartcs_tty_command` モジュールの`error_detect_on_module` オプションを未指定、あるいは`ok` を指定している場合は、`recvchar` を受信できずに文字列の送受信が停止してもPlaybookの実行結果はエラーになりません。  
Playbook の実行結果をエラーとしたい場合は、`failed` を指定してください。

2. Playbook 開始時点で想定された状態となっていない場合  
   - コンソール経由での操作となるため、Playbook 実行時のコンソールの状態は、ログイン前、ログイン後、コンフィグレーションモード移行後など、前回の操作内容により様々なケースが想定されます。  
`smartcs_tty_command` モジュールを使用した Playbook を作成する際は、最後に`exit` コマンドなどを実行してログアウト状態で終了する様な構成にすることを推奨いたします。  
   - また、`smartcs_tty_command` モジュールには、`sendchar` の送信を開始する前にコンソールの状態をチェックする機能(プレチェック機能)があります。Playbook 開始時に想定したコンソール状態になっていない場合、`sendchar` を送信せずに終了する、コンソールを期待した状態に戻すために`exit` コマンドを実行する、などの動作を指定する事が可能です。  

<br>
<br>

## 2. sendchar で指定した文字列の実行結果が stdout_lines などに正しく格納されない。
#### 想定原因
実行結果の出力内容が多い（長い）場合、出力にかかる時間に対して`smartcs_tty_command` の`cmd_timeout` オプションで指定している時間が短すぎる、あるいは`smartcs_tty_command` の`__WAIT__` オプションおよび`__NOWAIT__` オプションで指定している時間が短すぎるために、出力内容が `stdout`、`stdout_lines`、`stdout_lines_custom`の`response` データに入りきらず、次の`execute_command` や`response` に格納されてしまっている可能性があります。

#### 対処方法
`smartcs_tty_command` の`cmd_timeout` オプションや、`__WAIT__` オプション、`__NOWAIT__` オプションで指定している時間を、戻り値を出力しきれる秒数に設定してください。<br>
なお`cmd_timeout` の設定は、`sendchar` で指定しているすべての文字列送信に影響します。エラーなどにより`recvchar` で指定している文字列を受信できない場合、どの`sendchar` であっても、送信後に意図しない待ち時間が発生することになります。そのため、対象の`sendchar` のみに`__WAIT__` や`__NOWAIT__` を使用することを推奨します。<br>
また、`__WAIT__` オプションを使用する場合、出力内容に`recvchar` 内の文字列と完全一致する部分があると、意図せず待ち時間を終了して次の`sendchar` を送信してしまうため、注意が必要です。これを回避するには、`__WAIT__` オプションではなく`__NOWAIT__` オプションを使用することが有効です。<br>



[↑トップページに戻る](../README.md)
